<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุจูุงุจุฉ ุชูุฌูู ุฃุนุถุงุก ูุฌูุณ ุงูููุงุจ ุงูุฌุฏุฏ</title>
    <!-- ุชุญููู Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ุงุณุชุฎุฏุงู ุฎุท "Cairo" ููุบุฉ ุงูุนุฑุจูุฉ ูุน ุฎุท Inter ูุงุญุชูุงุทู -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            /* ุงููุงูุฑุฉ ูู ุงูุฎุท ุงูุฃุณุงุณูุ Inter ูุงุญุชูุงุทู ูุงุชูููุ ุซู ุฎุทูุท ุงููุธุงู */
            font-family: 'Cairo', 'Inter', sans-serif;
            background-color: #f7f9fb; /* ุฎูููุฉ ูุงุชุญุฉ ุฌุฏูุง */
        }
        .header-bg {
            background-color: #0d47a1; /* ุฃุฒุฑู ุฏุงูู (ููุฉ ูุซูุฉ) */
        }
        .primary-color {
            color: #1e88e5; /* ุฃุฒุฑู ุณูุงูู */
        }
        .primary-bg {
            background-color: #1e88e5;
        }
        .loading-animation {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e88ee;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- ุดุฑูุท ุงูุชููู (Header) -->
    <header class="header-bg shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <!-- ุงูุดุนุงุฑ/ุงูุนููุงู -->
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-white tracking-wide">ุจูุงุจุฉ ุงูุชูุฌูู ุงูุจุฑููุงูู</span>
                </div>
                <!-- ูุงุฆูุฉ ุงูุชููู -->
                <nav class="hidden md:flex space-x-4 space-x-reverse">
                    <a href="#home" class="text-white hover:bg-blue-600 px-3 py-2 rounded-md text-sm font-medium transition duration-150">ุงูุฑุฆูุณูุฉ</a>
                    <a href="#roles" class="text-white hover:bg-blue-600 px-3 py-2 rounded-md text-sm font-medium transition duration-150">ุงูุฃุฏูุงุฑ</a>
                    <a href="#assistant" class="text-white hover:bg-blue-600 px-3 py-2 rounded-md text-sm font-medium transition duration-150">ูุณุงุนุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู</a>
                    <a href="#resources" class="text-white hover:bg-blue-600 px-3 py-2 rounded-md text-sm font-medium transition duration-150">ุงูููุงุฑุฏ</a>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <!-- ูุณู ุงูุชุฑุญูุจ (Hero Section) -->
        <section id="home" class="py-20 md:py-32 primary-bg text-white shadow-xl">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold mb-4">
                    ูุฑุญุจุงู ุจูู ูู ูุฌูุณ ุงูููุงุจ
                </h1>
                <p class="text-xl sm:text-2xl mb-8 opacity-90">
                    ุฏููููู ุงูุดุงูู ูููุฌุงุญ ูู ูุณูุฑุชูู ุงูุชุดุฑูุนูุฉ ูุงูุฑูุงุจูุฉ ุงูุฌุฏูุฏุฉ.
                </p>
                <a href="#roles" class="inline-block bg-white text-blue-800 hover:bg-gray-100 font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                    ุงูุชุดู ุฏูุฑู ุงูุขู
                </a>
            </div>
        </section>

        <!-- ูุณู ุงูุฃุฏูุงุฑ ูุงููุณุคูููุงุช (Roles Section) -->
        <section id="roles" class="py-16 md:py-24">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-12 primary-color border-b-4 border-blue-200 inline-block pb-1">
                    ุงูุฃุฏูุงุฑ ูุงููุณุคูููุงุช ุงูุฃุณุงุณูุฉ
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    
                    <!-- ุงูุจุทุงูุฉ 1: ุงูุชุดุฑูุน -->
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 border-t-4 border-blue-500">
                        <div class="text-4xl primary-color mb-4 text-center">๐</div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800 text-center">ุงูุชุดุฑูุน ูุณู ุงูููุงููู</h3>
                        <p class="text-gray-600 text-right">
                            ุงููููุฉ ุงูุฃุณุงุณูุฉ ููู ูุงุฆุจุ ูุชุดูู ุตูุงุบุฉุ ูุงูุชุฑุงุญุ ููุฑุงุฌุนุฉุ ูุงูุชุตููุช ุนูู ุงูููุงููู ุงูุฌุฏูุฏุฉ ูุถูุงู ุชุทููุฑ ุงูููุธููุฉ ุงููุงููููุฉ.
                        </p>
                    </div>

                    <!-- ุงูุจุทุงูุฉ 2: ุงูุฑูุงุจุฉ -->
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 border-t-4 border-blue-500">
                        <div class="text-4xl primary-color mb-4 text-center">๐๏ธ</div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800 text-center">ุงูุฑูุงุจุฉ ุนูู ุงูุฃุฏุงุก ุงูุญูููู</h3>
                        <p class="text-gray-600 text-right">
                            ููุงุฑุณุฉ ุฃุฏูุงุช ุงูุฑูุงุจุฉ ุงูุจุฑููุงููุฉ (ุงูุงุณุชุฌูุงุจุ ุทูุจุงุช ุงูุฅุญุงุทุฉุ ุงูุฃุณุฆูุฉ) ูุถูุงู ุชูููุฐ ุงูุญูููุฉ ูุจุฑุงูุฌูุง ุจููุงุกุฉ ูุดูุงููุฉ.
                        </p>
                    </div>

                    <!-- ุงูุจุทุงูุฉ 3: ุงูุชูุซูู -->
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 border-t-4 border-blue-500">
                        <div class="text-4xl primary-color mb-4 text-center">๐ฃ๏ธ</div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800 text-center">ุชูุซูู ุงูุดุนุจ ูุงูุชูุงุตู</h3>
                        <p class="text-gray-600 text-right">
                            ุฃู ุชููู ุตูุช ุงูููุงุทููู ูู ุฏุงุฆุฑุชู ุงูุงูุชุฎุงุจูุฉุ ูููู ูููููู ูุชุทูุนุงุชูู ุฅูู ูุจุฉ ุงูุจุฑููุงู ูุงูุณุนู ูุญู ูุถุงูุงูู.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ูุณู ูุณุงุนุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู โจ (Gemini LLM Assistant) -->
        <section id="assistant" class="py-16 md:py-24 bg-gray-100">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-12 primary-color border-b-4 border-blue-300 inline-block pb-1">
                    โจ ูุณุงุนุฏ ุงูุจุญุซ ุงููุงูููู ูุงูุชุดุฑูุนู
                </h2>
                
                <div class="bg-white p-8 rounded-xl shadow-2xl">
                    <p class="text-lg text-gray-700 mb-6 text-center">
                        ุงุทุฑุญ ุณุคุงูู ุญูู ุฃู ูุงุฏุฉ ูุงููููุฉุ ูุงุฆุญุฉ ุฏุงุฎููุฉุ ุฃู ุฅุฌุฑุงุก ุจุฑููุงูู. ุณูููุฑ ูู ุงููุณุงุนุฏ ุฅุฌุงุจุฉ ููุฌุฒุฉ ูููุซูุฉ ุจุงูุจุญุซ.
                    </p>
                    
                    <!-- ููุทูุฉ ุงูุฅุฏุฎุงู -->
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <textarea id="llm-query" rows="3" placeholder="ูุซุงู: ูุง ูู ุตูุงุญูุงุช ุฑุฆูุณ ุงููุฌูุฉ ุงูุชุดุฑูุนูุฉ ุญุณุจ ุงููุงุฆุญุฉ ุงูุฏุงุฎููุฉุ" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800"></textarea>
                        <button id="llm-submit" class="primary-bg text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 transition duration-300 flex-shrink-0 flex items-center justify-center">
                            ุงุจุญุซ ุงูุขู
                        </button>
                    </div>

                    <!-- ููุทูุฉ ุงููุชุงุฆุฌ ูุงูุชุญููู -->
                    <div id="llm-loading" class="hidden flex items-center justify-center space-x-3 space-x-reverse mb-4">
                        <div class="loading-animation"></div>
                        <p class="text-blue-600 font-semibold">ุฌุงุฑู ุงูุจุญุซ ุนู ุงูุฅุฌุงุจุฉ...</p>
                    </div>

                    <div id="llm-response-box" class="mt-4 p-4 border border-blue-200 rounded-lg bg-blue-50 hidden">
                        <h4 class="text-xl font-bold text-blue-900 mb-3 border-b border-blue-300 pb-2">ุงูุฅุฌุงุจุฉ:</h4>
                        <div id="llm-answer" class="text-gray-800 leading-relaxed mb-4 whitespace-pre-wrap"></div>
                        
                        <h5 class="text-sm font-semibold text-blue-700 mt-4 pt-2 border-t border-blue-200">ุงููุตุงุฏุฑ (ููุชุฃูุฏ ูู ุงููุนูููุฉ):</h5>
                        <ul id="llm-sources" class="text-xs text-gray-600 list-disc pr-5 mt-1 space-y-1">
                            <!-- ุณูุชู ุฅุถุงูุฉ ุงููุตุงุฏุฑ ููุง -->
                        </ul>
                    </div>
                    
                    <div id="llm-error-box" class="mt-4 p-4 border border-red-400 rounded-lg bg-red-100 text-red-800 hidden">
                        <p id="llm-error-message" class="font-semibold text-center"></p>
                    </div>

                </div>
            </div>
        </section>

        <!-- ูุณู ุงูููุงุฑุฏ ุงูุฃุณุงุณูุฉ (Resources Section) -->
        <section id="resources" class="py-16 md:py-24 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-12 primary-color border-b-4 border-blue-200 inline-block pb-1">
                    ุงูููุงุฑุฏ ุงูุฃุณุงุณูุฉ ูุงูุฏุนู
                </h2>
                
                <div class="max-w-3xl mx-auto space-y-6">
                    <!-- ููุฑุฏ 1: ุงูุฏุณุชูุฑ -->
                    <div class="flex items-center p-5 bg-gray-50 rounded-lg shadow-md hover:bg-blue-50 transition duration-300">
                        <div class="text-2xl primary-color ml-4">๐</div>
                        <div class="flex-grow">
                            <h4 class="text-lg font-semibold text-gray-800" data-tts-text="ุงูุฏุณุชูุฑ ุงููุตุฑู. ุงููุฑุฌุน ุงูุฃุนูู ููุชุดุฑูุน ููุงูุฉ ุงูุตูุงุญูุงุช ุงูุจุฑููุงููุฉ.">ุงูุฏุณุชูุฑ ุงููุตุฑู</h4>
                            <p class="text-sm text-gray-500">ุงููุฑุฌุน ุงูุฃุนูู ููุชุดุฑูุน ููุงูุฉ ุงูุตูุงุญูุงุช ุงูุจุฑููุงููุฉ.</p>
                        </div>
                        <button class="tts-button bg-blue-500 text-white p-2 rounded-full shadow hover:bg-blue-600 transition duration-150 text-sm flex items-center justify-center min-w-[100px]">
                            ุงุณุชูุงุน โจ
                        </button>
                    </div>

                    <!-- ููุฑุฏ 2: ุงููุงุฆุญุฉ ุงูุฏุงุฎููุฉ -->
                    <div class="flex items-center p-5 bg-gray-50 rounded-lg shadow-md hover:bg-blue-50 transition duration-300">
                        <div class="text-2xl primary-color ml-4">๐</div>
                        <div class="flex-grow">
                            <h4 class="text-lg font-semibold text-gray-800" data-tts-text="ุงููุงุฆุญุฉ ุงูุฏุงุฎููุฉ ูููุฌูุณ. ุงูููุงุนุฏ ุงูุฅุฌุฑุงุฆูุฉ ุงูููุธูุฉ ูุณูุฑ ุงูุนูู ุฏุงุฎู ุงููุฌุงู ูุงูุฌูุณุงุช ุงูุนุงูุฉ.">ุงููุงุฆุญุฉ ุงูุฏุงุฎููุฉ ูููุฌูุณ</h4>
                            <p class="text-sm text-gray-500">ุงูููุงุนุฏ ุงูุฅุฌุฑุงุฆูุฉ ุงูููุธูุฉ ูุณูุฑ ุงูุนูู ุฏุงุฎู ุงููุฌุงู ูุงูุฌูุณุงุช ุงูุนุงูุฉ.</p>
                        </div>
                        <button class="tts-button bg-blue-500 text-white p-2 rounded-full shadow hover:bg-blue-600 transition duration-150 text-sm flex items-center justify-center min-w-[100px]">
                            ุงุณุชูุงุน โจ
                        </button>
                    </div>

                    <!-- ููุฑุฏ 3: ุจุฑูุงูุฌ ุงูุชูุฌูู -->
                    <div class="flex items-center p-5 bg-gray-50 rounded-lg shadow-md hover:bg-blue-50 transition duration-300">
                        <div class="text-2xl primary-color ml-4">๐</div>
                        <div class="flex-grow">
                            <h4 class="text-lg font-semibold text-gray-800" data-tts-text="ุจุฑูุงูุฌ ุงูุฅุนุฏุงุฏ ูุงูุชูุฌูู. ุฌุฏูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงููุฎุตุตุฉ ููุฃุนุถุงุก ุงูุฌุฏุฏ.">ุจุฑูุงูุฌ ุงูุฅุนุฏุงุฏ ูุงูุชูุฌูู</h4>
                            <p class="text-sm text-gray-500">ุฌุฏูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงููุฎุตุตุฉ ููุฃุนุถุงุก ุงูุฌุฏุฏ.</p>
                        </div>
                        <button class="tts-button bg-blue-500 text-white p-2 rounded-full shadow hover:bg-blue-600 transition duration-150 text-sm flex items-center justify-center min-w-[100px]">
                            ุงุณุชูุงุน โจ
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ูุณู ุชูุงุตู ูุนูุง (Contact Section) -->
        <section id="contact" class="py-16 md:py-24">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-12 primary-color border-b-4 border-blue-200 inline-block pb-1">
                    ุชูุงุตู ูุน ูุฑู ุงูุฏุนู
                </h2>
                
                <div class="max-w-2xl mx-auto bg-blue-800 text-white p-8 rounded-xl shadow-2xl text-center">
                    <p class="text-xl mb-6">
                        ูุฃู ุงุณุชูุณุงุฑุงุช ุฅุฌุฑุงุฆูุฉุ ูุงููููุฉุ ุฃู ููุฌุณุชูุฉุ ูุฅู ูุฑูู ุงูุฃูุงูุฉ ุงูุนุงูุฉ ุฌุงูุฒ ูุชูุฏูู ุงูุนูู ูุงูุฏุนู ุงููุงุฒู.
                    </p>
                    <div class="space-y-4">
                        <p class="text-lg font-medium">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุฏุนู:</p>
                        <a href="mailto:support@parliament.gov.eg" class="text-yellow-300 hover:text-yellow-400 text-2xl font-bold">support@parliament.gov.eg</a>
                        <p class="pt-4 text-lg font-medium">ูุงุชู ุงูููุชุจ ุงูููู:</p>
                        <p class="text-yellow-300 text-2xl font-bold">1234 567 890</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ุชุฐููู ุงูุตูุญุฉ (Footer) -->
    <footer class="header-bg mt-16 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-white text-sm">
            <p>&copy; 2025 ูุฌูุณ ุงูููุงุจ - ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
            <p class="mt-2 text-xs opacity-75">ูุฐู ุงูุจูุงุจุฉ ูุฎุตุตุฉ ูุชูุฌูู ุงูุณุงุฏุฉ ุงูุฃุนุถุงุก ุงูุฌุฏุฏ.</p>
        </div>
    </footer>

    <!-- JavaScript ูููุธุงุฆู ุงููุฏุนููุฉ ูู Gemini API -->
    <script>
        // Constants for API access
        const LLM_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const TTS_MODEL = 'gemini-2.5-flash-preview-tts';
        const apiKey = ""; // Canvas environment will provide the key
        
        // DOM Elements
        const llmQueryEl = document.getElementById('llm-query');
        const llmSubmitBtn = document.getElementById('llm-submit');
        const llmLoadingEl = document.getElementById('llm-loading');
        const llmResponseBoxEl = document.getElementById('llm-response-box');
        const llmAnswerEl = document.getElementById('llm-answer');
        const llmSourcesEl = document.getElementById('llm-sources');
        const llmErrorBoxEl = document.getElementById('llm-error-box');
        const llmErrorMessageEl = document.getElementById('llm-error-message');

        // Utility function for exponential backoff retry logic
        async function exponentialBackoff(fn, maxRetries = 5, delay = 1000) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** attempt)));
                }
            }
        }

        /**
         * Transforms base64 encoded string to ArrayBuffer.
         * @param {string} base64 The base64 string.
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Converts PCM audio data into a WAV Blob.
         * @param {Int16Array} pcm16 PCM audio data (signed 16-bit).
         * @param {number} sampleRate Sample rate (e.g., 16000).
         * @returns {Blob} The WAV audio blob.
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM
            const dataLength = pcm16.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            let offset = 0;
            // Helper function to write a string
            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
                offset += str.length;
            }

            // RIFF chunk
            writeString('RIFF'); offset += 4; // Chunk ID
            view.setUint32(offset, 36 + dataLength, true); offset += 4; // Chunk Size
            writeString('WAVE'); offset += 4; // Format

            // FMT sub-chunk
            writeString('fmt '); offset += 4; // Sub-chunk 1 ID
            view.setUint32(offset, 16, true); offset += 4; // Sub-chunk 1 Size (16 for PCM)
            view.setUint16(offset, 1, true); offset += 2; // Audio Format (1 for PCM)
            view.setUint16(offset, numChannels, true); offset += 2; // Num Channels
            view.setUint32(offset, sampleRate, true); offset += 4; // Sample Rate
            view.setUint32(offset, sampleRate * numChannels * bytesPerSample, true); offset += 4; // Byte Rate
            view.setUint16(offset, numChannels * bytesPerSample, true); offset += 2; // Block Align
            view.setUint16(offset, 16, true); offset += 2; // Bits Per Sample

            // Data sub-chunk
            writeString('data'); offset += 4; // Sub-chunk 2 ID
            view.setUint32(offset, dataLength, true); offset += 4; // Sub-chunk 2 Size

            // Write the PCM data
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true); // Signed 16-bit little-endian
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        /**
         * Fetches grounded content from the Gemini API.
         * @param {string} userQuery The question asked by the user.
         */
        async function fetchGroundedContent(userQuery) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${apiKey}`;
            
            // System instructions guide the model's persona and output format
            const systemPrompt = "Act as a specialized legal and parliamentary analyst, fluent in modern standard Arabic. Your role is to concisely and accurately answer questions related to national laws, legislative procedures, and parliamentary etiquette based on the search results provided. Do not invent information. Ensure the response is formal and direct.";

            // Standard payload for grounded search. The model determines the best search queries based on the userQuery and system instruction.
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const fetchCall = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            };

            try {
                const result = await exponentialBackoff(fetchCall);
                const candidate = result.candidates?.[0];

                llmResponseBoxEl.classList.remove('hidden');
                llmErrorBoxEl.classList.add('hidden');
                llmAnswerEl.innerHTML = '';
                llmSourcesEl.innerHTML = '';
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    // Use innerText to preserve line breaks from the model's response and prevent XSS
                    llmAnswerEl.innerText = text; 

                    // Extract and display grounding sources
                    const groundingMetadata = candidate.groundingMetadata;
                    let sources = [];
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    if (sources.length > 0) {
                        sources.forEach(source => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = source.uri;
                            a.target = "_blank";
                            a.className = "hover:underline text-blue-600";
                            a.textContent = source.title + " (ุงููุตุฏุฑ)";
                            li.appendChild(a);
                            llmSourcesEl.appendChild(li);
                        });
                    } else {
                        llmSourcesEl.innerHTML = '<li>ูู ูุชู ุงูุนุซูุฑ ุนูู ูุตุงุฏุฑ ุจุญุซ ูุญุฏุฏุฉ.</li>';
                    }

                } else {
                    llmAnswerEl.innerText = 'ุนุฐุฑุงูุ ูู ุฃุชููู ูู ุงูุนุซูุฑ ุนูู ุฅุฌุงุจุฉ ูุงููุฉ ูุณุคุงูู.';
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                llmResponseBoxEl.classList.add('hidden');
                llmErrorBoxEl.classList.remove('hidden');
                llmErrorMessageEl.innerText = `ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุงูุฎุฏูุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู. (ุงูุฎุทุฃ: ${error.message})`;
            } finally {
                llmLoadingEl.classList.add('hidden');
                llmSubmitBtn.disabled = false;
                llmSubmitBtn.textContent = 'ุงุจุญุซ ุงูุขู';
            }
        }


        // Event Listener for LLM Submit Button
        llmSubmitBtn.addEventListener('click', () => {
            const query = llmQueryEl.value.trim();

            if (query.length < 5) {
                llmErrorBoxEl.classList.remove('hidden');
                llmErrorMessageEl.innerText = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุณุคุงู ุฃูุซุฑ ุชูุตููุงู (5 ุฃุญุฑู ุนูู ุงูุฃูู).';
                llmResponseBoxEl.classList.add('hidden');
                return;
            }

            llmErrorBoxEl.classList.add('hidden');
            llmLoadingEl.classList.remove('hidden');
            llmSubmitBtn.disabled = true;
            llmSubmitBtn.textContent = 'ุฌุงุฑู ุงูุจุญุซ...';
            
            fetchGroundedContent(query);
        });

        /**
         * Fetches TTS audio from the Gemini API and plays it.
         * @param {string} text The text to be spoken.
         * @param {HTMLButtonElement} button The button element to disable/enable.
         */
        async function fetchTtsAudio(text, button) {
            button.disabled = true;
            const originalText = button.innerHTML;
            button.innerHTML = 'ุฌุงุฑู ุงูุชุญููู...';

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`;

            // Using 'Kore' voice for a firm, professional tone suitable for official documents in Arabic.
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
            };

            const fetchCall = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            };

            try {
                const result = await exponentialBackoff(fetchCall);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    // API returns signed PCM16 audio data.
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        URL.revokeObjectURL(audioUrl); // Clean up the object URL
                    };
                    
                    audio.onerror = () => {
                        console.error("Audio playback error.");
                        button.innerHTML = "ุฎุทุฃ ูู ุงูุชุดุบูู!";
                        setTimeout(() => {
                             button.innerHTML = originalText;
                             button.disabled = false;
                        }, 2000);
                        URL.revokeObjectURL(audioUrl);
                    };

                } else {
                    throw new Error("Invalid audio response structure or missing data.");
                }

            } catch (error) {
                console.error("TTS API Error:", error);
                button.innerHTML = "ุฎุทุฃ!";
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }
        
        // Event Listeners for TTS Buttons
        document.querySelectorAll('.tts-button').forEach(button => {
            button.addEventListener('click', (event) => {
                const parentDiv = event.currentTarget.closest('.flex');
                // Get the descriptive text from the data-tts-text attribute of the h4 element
                const textElement = parentDiv.querySelector('[data-tts-text]');
                if (textElement) {
                    const textToSpeak = textElement.getAttribute('data-tts-text');
                    fetchTtsAudio(textToSpeak, event.currentTarget);
                }
            });
        });
        
    </script>
</body>
</html>
